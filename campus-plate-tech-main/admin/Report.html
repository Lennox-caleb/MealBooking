<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Reports | ANU Cafeteria</title>

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

  <style>
    :root {
      --red: #ff0000;
      --yellow: #fac823;
      --white: #ffffff;
      --black: #000000;
      --gray: #f7f7f7;
    }

    body {
      margin: 0;
      font-family: "Segoe UI", sans-serif;
      display: flex;
      background: var(--gray);
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: 240px;
      background: linear-gradient(180deg, var(--red), var(--yellow));
      color: var(--white);
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 15px 10px;
    }

    .sidebar img {
      width: 80px;
      height: 80px;
      margin-bottom: 10px;
    }

    .sidebar h2 {
      text-align: center;
      font-size: 16px;
      margin: 5px 0 15px;
    }

    .sidebar a {
      color: var(--white);
      text-decoration: none;
      display: block;
      width: 90%;
      padding: 8px 15px;
      border-radius: 8px;
      margin: 3px 0;
      transition: background 0.3s;
    }

    .sidebar a.active,
    .sidebar a:hover {
      background: rgba(255, 255, 255, 0.25);
    }

    .logout-btn {
      margin-top: auto;
      background: var(--black);
      text-align: center;
      padding: 10px;
      border-radius: 8px;
      cursor: pointer;
      width: 90%;
    }

    /* Main */
    .main {
      flex: 1;
      display: flex;
      flex-direction: column;
    }

    .topbar {
      background: var(--white);
      box-shadow: 0 2px 6px rgba(0, 0, 0, 0.1);
      padding: 15px 25px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .topbar h1 {
      color: var(--red);
      margin: 0;
      font-size: 20px;
    }

    .export-buttons button {
      background: var(--yellow);
      border: none;
      padding: 8px 14px;
      border-radius: 6px;
      font-weight: 600;
      cursor: pointer;
      transition: 0.3s;
    }

    .export-buttons button:hover {
      background: #ffd633;
    }

    .content {
      padding: 25px;
    }

    .cards {
      display: flex;
      gap: 15px;
      margin-bottom: 25px;
      flex-wrap: wrap;
    }

    .card {
      flex: 1;
      background: var(--white);
      padding: 15px;
      border-radius: 10px;
      text-align: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      min-width: 180px;
    }

    .card h3 {
      margin: 5px 0;
      color: var(--red);
    }

    .charts {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 25px;
      margin-bottom: 25px;
    }

    .chart-container {
      background: var(--white);
      border-radius: 10px;
      padding: 15px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: var(--white);
      border-radius: 10px;
      overflow: hidden;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    th, td {
      padding: 10px;
      border-bottom: 1px solid #eee;
      text-align: left;
      font-size: 14px;
    }

    th {
      background: var(--yellow);
      color: var(--black);
    }

    tr:hover {
      background: #f9f9f9;
    }

    .status {
      padding: 4px 8px;
      border-radius: 6px;
      color: var(--white);
      font-size: 12px;
      text-transform: capitalize;
    }

    .pending { background: #999; }
    .consumed { background: #28a745; }

    .toast {
      position: fixed;
      top: 15px;
      right: 15px;
      background: var(--yellow);
      color: var(--black);
      padding: 12px 16px;
      border-radius: 8px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.2);
      animation: fadeInOut 3s ease forwards;
    }

    @keyframes fadeInOut {
      0% { opacity: 0; transform: translateY(-10px); }
      10%, 90% { opacity: 1; transform: translateY(0); }
      100% { opacity: 0; transform: translateY(-10px); }
    }
  </style>
</head>

<body>
  <div class="sidebar">
    <img src="../public/ANU-Logo-PNG-logo (1).png" alt="ANU Logo">
   
    <a href="Dashboard.html">Dashboard</a>
    <a href="BookingManagement.html">Booking Management</a>
    <a href="MenuManagement.html">Menu Management</a>
    <a href="MealValidation.html">Meal Validation</a>
    <a href="Report.html" class="active">Reports</a>
    <a href="UserManagement.html" class="restricted">User Management</a>
    <a href="Setting.html" class="restricted">Settings</a>
    <div class="logout-btn" id="logoutBtn">Logout</div>
  </div>

  <div class="main">
    <div class="topbar">
      <h1>Reports & Analytics</h1>
      <div class="export-buttons">
        <button id="exportCSV">Export CSV</button>
        <button id="exportPDF">Export PDF</button>
      </div>
    </div>

    <div class="content">
      <div class="cards">
        <div class="card"><h3 id="totalBookings">0</h3><p>Total Bookings</p></div>
        <div class="card"><h3 id="consumedCount">0</h3><p>Consumed Meals</p></div>
        <div class="card"><h3 id="pendingCount">0</h3><p>Pending Meals</p></div>
        <div class="card"><h3 id="topMeal">-</h3><p>Top Meal</p></div>
      </div>

      <div class="charts">
        <div class="chart-container"><canvas id="mealChart"></canvas></div>
        <div class="chart-container"><canvas id="dailyChart"></canvas></div>
      </div>

      <table>
        <thead>
          <tr>
            <th>Booking Code</th>
            <th>Student Name</th>
            <th>Meal</th>
            <th>Date</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="reportBody"></tbody>
      </table>
    </div>
  </div>

<script>
  const logoutBtn = document.getElementById("logoutBtn");
  const reportBody = document.getElementById("reportBody");
  const exportCSVBtn = document.getElementById("exportCSV");
  const exportPDFBtn = document.getElementById("exportPDF");
  let mealChart, dailyChart;

  window.addEventListener("DOMContentLoaded", () => {
    const session = JSON.parse(localStorage.getItem("anu_session"));
    if (!session) return (window.location.href = "../login.html");

    if (session.role !== "Super Admin") {
      document.querySelectorAll(".restricted").forEach(el => el.style.display = "none");
    }

    loadReports();
    window.addEventListener("storage", (e) => { if (e.key === "anu_bookings") loadReports(); });
  });

  function resolveStudentName(b, users) {
    if (b.fullname && b.fullname !== "undefined") return b.fullname;
    if (b.student && b.student !== "undefined") return b.student;
    const match = users.find(u => u.username === b.username || u.id === b.userId);
    if (match) return match.fullname || match.username;
    return b.username || "Unknown Student";
  }

  function resolveMealName(b, menus) {
    if (b.meal && b.meal !== "undefined") return b.meal;
    if (b.mealName && b.mealName !== "undefined") return b.mealName;
    const m = menus.find(m => m.id === b.menuId || m.menuId === b.menuId);
    return m ? m.name || m.mealName : b.menuId || "Unknown Meal";
  }

  function loadReports() {
    const bookings = JSON.parse(localStorage.getItem("anu_bookings")) || [];
    const users = JSON.parse(localStorage.getItem("anu_users")) || [];
    const menus = JSON.parse(localStorage.getItem("anu_menu")) || [];

    const total = bookings.length;
    const consumed = bookings.filter(b => b.status === "consumed").length;
    const pending = total - consumed;

    const mealCount = {};
    const dateCount = {};

    bookings.forEach(b => {
      const mealName = resolveMealName(b, menus);
      const date = new Date(b.date).toLocaleDateString();
      mealCount[mealName] = (mealCount[mealName] || 0) + 1;
      dateCount[date] = (dateCount[date] || 0) + 1;
    });

    const topMeal = Object.entries(mealCount).sort((a, b) => b[1] - a[1])[0]?.[0] || "-";

    document.getElementById("totalBookings").textContent = total;
    document.getElementById("consumedCount").textContent = consumed;
    document.getElementById("pendingCount").textContent = pending;
    document.getElementById("topMeal").textContent = topMeal;

    reportBody.innerHTML = bookings.map(b => `
      <tr>
        <td>${b.code}</td>
        <td>${resolveStudentName(b, users)}</td>
        <td>${resolveMealName(b, menus)}</td>
        <td>${new Date(b.date).toLocaleDateString()}</td>
        <td><span class="status ${b.status}">${b.status}</span></td>
      </tr>
    `).join("");

    updateCharts(mealCount, dateCount);
  }

  function updateCharts(mealCount, dateCount) {
    const mealCtx = document.getElementById("mealChart").getContext("2d");
    const dailyCtx = document.getElementById("dailyChart").getContext("2d");

    if (mealChart) mealChart.destroy();
    if (dailyChart) dailyChart.destroy();

    mealChart = new Chart(mealCtx, {
      type: "pie",
      data: {
        labels: Object.keys(mealCount),
        datasets: [{
          data: Object.values(mealCount),
          backgroundColor: ["#ff0000aa", "#fac823aa", "#000000aa", "#28a745aa"]
        }]
      },
      options: { responsive: true, plugins: { legend: { position: "bottom" } } }
    });

    dailyChart = new Chart(dailyCtx, {
      type: "line",
      data: {
        labels: Object.keys(dateCount),
        datasets: [{
          label: "Bookings per Day",
          data: Object.values(dateCount),
          borderColor: "#ff0000",
          backgroundColor: "#fac82355",
          fill: true
        }]
      },
      options: { responsive: true, scales: { y: { beginAtZero: true } } }
    });
  }

  exportCSVBtn.addEventListener("click", () => {
    const bookings = JSON.parse(localStorage.getItem("anu_bookings")) || [];
    const users = JSON.parse(localStorage.getItem("anu_users")) || [];
    const menus = JSON.parse(localStorage.getItem("anu_menu")) || [];
    const csvRows = [["Code","Student","Meal","Date","Status"]];
    bookings.forEach(b => csvRows.push([
      b.code,
      resolveStudentName(b, users),
      resolveMealName(b, menus),
      new Date(b.date).toLocaleDateString(),
      b.status
    ]));
    const blob = new Blob([csvRows.map(r=>r.join(",")).join("\n")], {type:"text/csv"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = "meal_report.csv";
    a.click();
  });

  exportPDFBtn.addEventListener("click", async () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    doc.text("ANU Cafeteria Report", 14, 15);
    const bookings = JSON.parse(localStorage.getItem("anu_bookings")) || [];
    const users = JSON.parse(localStorage.getItem("anu_users")) || [];
    const menus = JSON.parse(localStorage.getItem("anu_menu")) || [];
    let y = 25;
    bookings.forEach(b => {
      const text = `${b.code} | ${resolveStudentName(b, users)} | ${resolveMealName(b, menus)} | ${new Date(b.date).toLocaleDateString()} | ${b.status}`;
      doc.text(text, 14, y);
      y += 8;
    });
    doc.save("meal_report.pdf");
  });

  logoutBtn.addEventListener("click", () => {
    localStorage.removeItem("anu_session");
    window.location.href = "../login.html";
  });

  function showToast(msg) {
    const toast = document.createElement("div");
    toast.className = "toast";
    toast.textContent = msg;
    document.body.appendChild(toast);
    setTimeout(() => toast.remove(), 3000);
  }
</script>
</body>
</html>
